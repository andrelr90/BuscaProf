<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <script src="../backend/node_modules/vue/dist/vue.global.js"></script>
        <link rel="stylesheet" href="./css/style.css">
        <link rel="stylesheet" href="./css/chat.css">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0">
        <meta charset="UTF-8">
    </head>

    <body>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

        <div id="nav-vue">
            <nav-vue></nav-vue>
        </div>


        


        <main id="chat">
            <section id="contactScreen" ref="contactScreen">
                <section id="headContacts">
                    Contatos:
                </section>
                <section class="contacts">
                    <section class="contact" v-for="contact in contacts" @click="showMessageScreen(`${contact.name}`, `${contact.id}`)">
                        {{contact.name}}
                    </section>
                    <br/>
                </section>
            </section>
            <section id="chatPage" ref="chatPage">
                <section id="headChat">
                    <div @click="showContactScreen()" id="backButton">&nbsp;&nbsp;&#60;</div>
                    <div ref="contactName">Professor name</div>
                </section>
                <section ref="chatArea" class="chat-area">
                    <p v-for="message in messages" class="message" :class="{ 'message-out': message.author === 'you', 'message-in': message.author !== 'you' }">
                        {{ message.body }}
                    </p>
                </section>
            
                <section class="chat-inputs">
                    <form @submit.prevent="sendMessage('out')" id="person1-form" style="display: contents;" autocomplete="off">
                        <input v-model="youMessage" id="person1-input" type="text" class="form-control mr-sm-2">
                        <button class="btn btn-outline-primary" type="submit">Enviar</button>
                    </form>
                </section>
            </section>
        </main>

        <div id="chatButton">
            <div class="buttonContainer" @click="toggleChat()">
                <img src="imagens/chat-icon.png" style="width: 60%" id="buttonChatIcon">
            </div>
        </div>


        <div id="footer-vue">
            <footer-vue></footer-vue>
        </div>
        
    </body>

    <script src="vue-components/nav.js"></script>
    <script src="vue-components/footer.js"></script>

    <script>
        function _get(key) {
            var _name = key + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(_name) == 0) return c.substring(_name.length, c.length);
            }
            return null;
        };

        Vue.createApp({
            data() {
                return {
                    contacts: [
                        {name: "JoÃ£o da Silva Costa", id: 1}, 
                        {name: "Manoel Carlinhos", id: 2}, 
                        {name: "Uncle Ducson", id: 3},
                    ],
                    bobMessage: '',
                    youMessage: '',
                    messages: [
                        {
                            body: 'Teste',
                            author: 'professor'
                        },
                        {
                            body: 'Teste2',
                            author: 'you'
                        }
                    ]
                }
            },
            methods: {
                sendMessage(direction) {
                    if (!this.youMessage && !this.bobMessage) {
                        return
                    }
                    if (direction === 'out') {
                        this.messages.push({body: this.youMessage, author: 'you'})
                        this.youMessage = ''
                        // Also add to the database here.
                    } else {
                        alert('something went wrong')
                    }
                    Vue.nextTick(() => {
                        let messageDisplay = this.$refs.chatArea
                        messageDisplay.scrollTop = messageDisplay.scrollHeight
                    })
                },
                loadContacts(){
                    console.log("Loading contacts");
                    // get contacts from the database here.
                },
                showContactScreen(){
                    this.messages = [];
                    this.$refs.contactScreen.style.display="block";
                    this.$refs.chatPage.style.display="none";
                },
                showMessageScreen(name, id){
                    // get messages for this id here. Use function _get to get the cookie with the logged user id.
                    this.$refs.contactName.innerHTML = name;
                    this.$refs.contactScreen.style.display="none";
                    this.$refs.chatPage.style.display="block";
                }
            },
            created() {
                this.loadContacts();
                this.interval = setInterval(() => this.loadContacts(), 3000);
            },
        }).mount("#chat")

        Vue.createApp({
            data(){
                return {
                    isOpen: false
                }
            },
            methods: {
                toggleChat(){
                    if(!this.isOpen){
                        document.getElementById("chat").style.display = "inline-block";
                        document.getElementById("buttonChatIcon").src = "imagens/chat-close.png";
                    } else{
                        document.getElementById("chat").style.display = "none";
                        document.getElementById("buttonChatIcon").src = "imagens/chat-icon.png";
                    }
                    this.isOpen = !this.isOpen;
                }
            }
        }).mount("#chatButton")
    </script>

</html>